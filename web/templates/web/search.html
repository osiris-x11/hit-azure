{% extends "web/includes/base.html" %}

{% load humanize %}

{% block title %}Search Results{% endblock %}

{% block content %}

<form class="navbar-search" action="{% url search %}">
    <input class="form-control" type="text" name="q" class="search-query" placeholder="Search" value="{{q}}" autocomplete="off">

    Only show companies that are:
    <label>
    <input type="checkbox" name="opts" value="minority" {% if 'minority' in opts %}checked{%endif%}> Minority-Owned</label>

    <label>
    <input type="checkbox" name="opts" value="woman" {% if 'woman' in opts %}checked{%endif%}> Woman-Owned</label>

    <label>
    <input type="checkbox" name="opts" value="veteran" {% if 'veteran' in opts %}checked{%endif%}> Veteran-Owned</label>

    <label>
    <input type="checkbox" name="opts" value="green" {% if 'green' in opts %}checked{%endif%}> Green</label>

    <br />
    Expanded search: 
    <label>
    <input type="checkbox" name="opts" value="full" {% if 'full' in opts %}checked{%endif%}> Include Companies outside my <a href="{%url settings%}">Preferences</a></label>

    <input class="btn btn-primary" type="submit" value="Search" />
</form>

<div id="map" style="height:400px;display:none"></div>

<script type="text/javascript">
var rows = {{rows_json|safe}};
</script>
<script type="text/javascript">
var mapIt = function()
{
    var map = L.map('map');//.setView([30.2669, -97.7428], 12);
    L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
            }).addTo(map);


    (function(){
        var coords;
        var markers = L.markerClusterGroup();
        var mapEmpty = true;
        $(rows).each(function(idx, row){
            if (row.Location.Latitude !== null && row.Location.Longitude !== null)
            {
                mapEmpty = false;
                var marker = L.marker(new L.LatLng(row.Location.Latitude, row.Location.Longitude), { title: row.Name });
                marker.bindPopup(row.Name);
                markers.addLayer(marker);
            }

        });

        if (mapEmpty)
            return;
        $('#map').show();
        map.addLayer(markers);
        map.fitBounds(markers.getBounds());
    })();
}

{% if rows %}
mapIt()
{%endif%}
</script>

<h3>Search Results</h3>
Results: {{totalRows|intcomma}}, Displaying: {{rows|length}}

<ul class="pagination">
      <li {% if not pages_prev.0.url %}class="disabled"{%endif%}><a href="{{pages_prev.0.url}}">&laquo;</a></li>


        {% for page in pages %}
          <li {% if page_num == page.num %}class="active"{%endif%}><a href="{{page.url}}">{{page.num}}</a></li>
        {% endfor %}

      <li {% if not pages_next.0.url %}class="disabled"{%endif%}><a href="{{pages_next.0.url}}">&raquo;</a></li>
</ul>

<table class="table table-striped">
    <thead>
        <tr>
            <th>DUNS</th>
            <th>Company</th>
            <th>Location</th>
            <th>Size</th>
        </tr>
    </thead>
    <tbody>
        {% for row in rows %}
        <tr>
            <td>
                {{row.DUNS}}
                <button onclick="addCompany('{{row.DUNS}}')">add</button>
            </td>
            <td>
                <a href="{% url company row.DUNS %}">{{row.Name}}</a>
            </td>
            <td>
                {{row.Location.Street1}}<br/>
                {{row.Location.City}}, {{row.Location.State}} {{row.Location.PostalCode}}<br />
                {{row.Location.Country}}
            </td>
            <td>
                {{ row.EmployeesTotal }}
                {{ row.EmployeesHere }}
                {{ row.AnnualSalesUSD }}
            </td>
            <td>
                {% include 'web/includes/co_indicators.html' with co=row %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!--
<select data-bind="foreach: sics" multiple>
    <option data-bind="text: name"></option>
</select>
-->

{% endblock %}